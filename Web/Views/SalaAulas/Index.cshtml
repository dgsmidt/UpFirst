@model DAL.Models.CursoAluno;

@{
    Layout = "_LayoutUpFirst";
    ViewData["Title"] = "Sala de Aula";
    var anotacoes = "";
    var avaliacaoText = "";
    var culture = System.Globalization.CultureInfo.CurrentCulture.Name;

    if (culture == "en")
    {
        avaliacaoText = "Evaluation";
    }
    else
    {
        avaliacaoText = "Avaliação";
    }
}

<main class="othersPages" role="main">
    <input class="form-control" id="assistindoAulaId" hidden />
    <input class="form-control" value="@ViewData["AlunoId"]" id="alunoId" hidden />
    @*<div class="container">
            <div class="row">
                <div class="col col-lg-2">
                    <label class="text-white">AulaId</label>
                    <input class="form-control" id="assistindoAulaId" /><br />
                </div>
                <div class="col col-lg-2">
                    <label class="text-white">AlunoId</label>
                    <input class="form-control" value="@Model.Alunos[0].Id" id="alunoId" />
                </div>
            </div>
        </div>*@
    <section class="container-fluid aula">
        <div class="row">

            <div class="col-3 menuAulas">
                <h2>@Model.Curso.Nome</h2>
                @foreach (var modulo in Model.ModulosAlunos)
                {
                    <ul class="modulo ativo">
                        @* Tem a classe desativo tambem*@

                        @modulo.Modulo.Descricao
                        @foreach (var aula in modulo.AulasAlunos)
                        {
                            @*<li class="realizado"><a href="#">Aula 01</a></li>
                                <li class="ativo"><a href="#">Aula 02</a></li>*@
                            @*@if (aula.AulasAlunos.Count > 0)
                                {
                                    var classToAdd = "li-aula";
                                    if (aula.AulasAlunos[0].Assistindo)
                                    {
                                        classToAdd += " ativo";
                                        anotacoes = aula.AulasAlunos[0].Anotacoes;
                                    }
                                    if (aula.AulasAlunos[0].Assistida) classToAdd += " realizado";
                                    <li @Html.Raw("class='" + classToAdd + "'")><a id="@aula.Id" class="itemAula" name="@aula.Video" style="cursor: pointer">@aula.Descricao</a></li>
                                }
                                else
                                {
                                    <li class="li-aula"><a id="@aula.Id" class="itemAula" name="@aula.Video" style="cursor: pointer">@aula.Descricao</a></li>

                                }*@

                            var classToAdd = "li-aula";
                            if (aula.Assistindo)
                            {
                                classToAdd += " ativo";
                                anotacoes = aula.Anotacoes;
                            }
                            if (aula.Assistida) classToAdd += " realizado";
                            <li @Html.Raw("class='" + classToAdd + "'")><a id="@aula.AulaId" class="itemAula" name="@aula.Aula.Video" style="cursor: pointer">@aula.Aula.Descricao</a></li>
                        }
                        @*Avaliação*@
                        @*<li class="li-aula"><a class="itemAula" asp-controller="Home" asp-action="Avaliacao" asp-route-alunoId="@ViewData["AlunoId"]" asp-route-avaliacaoId="@modulo.AvaliacaoId" style="cursor: pointer" localize-content>Evaluation</a></li>*@


                    </ul>
                    @*<button id="avaliacao_@modulo.AvaliacaoId" disabled class="btn btn-primary mb-5" localize-content>Avaliação</button>*@
                    if (modulo.AvaliacaoLiberada && modulo.Modulo.AvaliacaoId != null)
                    {
                        <input id="avaliacao_@modulo.Modulo.AvaliacaoId" type="button" class="btn btn-primary mb-5 btn-avaliacao" value="@avaliacaoText" onclick="@("window.location.href='" + @Url.Action("Avaliacao", "Home", new { alunoId = @ViewData["AlunoId"], avaliacaoId =  @modulo.Modulo.AvaliacaoId}) + "'");" />
                    }
                    else
                    {
                        <input id="avaliacao_@modulo.Modulo.AvaliacaoId" type="button" hidden class="btn btn-primary mb-5 btn-avaliacao" value="@avaliacaoText" onclick="@("window.location.href='" + @Url.Action("Avaliacao", "Home", new { alunoId = @ViewData["AlunoId"], avaliacaoId =  @modulo.Modulo.AvaliacaoId}) + "'");" />
                    }

                }

                <img class="btn-menu-video abrirMenu" onclick="AbrirMenu()" src="~/assets/images/abre_menu_video.svg" alt="abrir menu" border="0">
                <img class="btn-menu-video fecharMenu" onclick="FecharMenu()" src="~/assets/images/fecha_menu_video.svg" alt="fechar menu" border="0">

            </div>
            <div class="col-9 videoAula">

                <h1 id="nomeAula"></h1>
                <section class="video">
                    @*https://player.vimeo.com/video/141439971
                        https://player.vimeo.com/video/141561250
                        https://player.vimeo.com/video/444387842
                        https://player.vimeo.com/video/116629498
                        https://player.vimeo.com/video/436144408
                        https://player.vimeo.com/video/116619880*@
                    <div style="padding:56.25% 0 0 0;position:relative;">
                        @*<iframe id="iFrame" src="" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>*@
                        <iframe id="iFrame" style="position:absolute;top:0;left:0;width:100%;height:100%;"
                                src=""
                                frameborder="0"
                                allowfullscreen></iframe>
                    </div>
                    @*<script src="https://player.vimeo.com/api/player.js"></script>*@
                    <input id="checkAssistida" type="checkbox" class="mr-2 mt-2" localize-content />@Localizer.Text("Watched")
                </section>

                <section class="anotacaoAula">
                    <h3 localize-content>Make notes of this Class:</h3>
                    <form>
                        <textarea class="form-control" id="validationTextarea" placeholder="@Localizer.Text("Make your notes here ...")" required="">@anotacoes</textarea>
                    </form>
                    @*<button id="btnSalvarAnotacoes" class="btn btn-primary mt-2">Salvar</button>*@
                </section>

                <section class="descricaoAula">
                    <h3 localize-content>Support Material:</h3>
                    <p id="materialApoio">
                        @*Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat. Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi. Lorem ipsum dolor sit amet, cons ectetue*@
                    </p>
                    <h3 localize-content>Support Files:</h3>
                    <p id="arquivosApoio">
                        @*<a href="https://example.com">Website</a>*@
                        @*Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat. Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi. Lorem ipsum dolor sit amet, cons ectetue*@
                    </p>

                </section>

            </div>
        </div>
    </section>

    @*<input type="text" id="YoutubeUrl" style="width:300px" />
        <input type="button" id="PlayVideo" value="Play" />
        <hr />
        <iframe id="YouTubevideo" width="420" height="315"
                frameborder="0" style="display:none"
                allowfullscreen></iframe>*@
</main>

<!-- Button trigger modal -->
@*<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter">
        Launch demo modal
    </button>*@

<!-- Modal -->
<div class="modal fade" id="avaliacaoLiberada" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Avaliação Liberada</h5>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>*@
            </div>
            <div class="modal-body" localize-content>
                You can now evaluate this module !
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" localize-content>Close</button>
                @*<button type="button" class="btn btn-primary">Save changes</button>*@
            </div>
        </div>
    </div>
</div>

<script src="~/lib/jquery/jquery.min.js"></script>
<script>
    $(document).ready(function () {

        //$(".menuAulas").css("transition", "max-width 2s")
        $(".menuAulas").css("transition", "max-height .2s")
        //$(".modulo").css("transition", "display 2s");

        // Ajustes finais da aula sendo assistida
        $(".li-aula").each(function (index) {
            if ($(this).hasClass("ativo")) {
                $("#assistindoAulaId").attr("value", $(this).children().attr("id"));
                $("#iFrame").attr("src", PlayVideo($(this).children().attr("name")));
                $("#nomeAula").text($(this).children().text());
                getMaterialApoio($(this).children().attr("id"));
                getStatusCheckAssistida($(this).children().attr("id"), $("#alunoId").val());
                getArquivosApoio($(this).children().attr("id"));
            };
        });
    });

    $(function () {
        // Quando tira o foco de anotações da aula
        $("#validationTextarea").focusout(function () {
            postAnotacoes($("#assistindoAulaId").val(), $("#alunoId").val(), $("#validationTextarea").val());
        });

        // Quando clica em salvar anotações
        $("#btnSalvarAnotacoes").click(function () {
            postAnotacoes($("#assistindoAulaId").val(), $("#alunoId").val(), $("#validationTextarea").val());
        });

        // Quando clica numa aula
        $(".itemAula").click(function (obj) {
            $("#nomeAula").text($(obj.target).text());

            // Limpa ativo de todas as aulas
            $(".li-aula").each(function (index) {
                $(this).removeClass("ativo");
            });

            // Adiciona ativo à aula clicada
            $(obj.target).parent().addClass("ativo");

            // Obter status de aula assistida (da aula clicada) e habilitar ou não o checkBox
            getStatusCheckAssistida($(obj.target).attr("id"), $("#alunoId").val());

            // Carregar o video da aula clicada
            $("#iFrame").attr("src", PlayVideo($(obj.target).attr("name")));

            $("#assistindoAulaId").attr("value", $(obj.target).attr("id"));

            // Atualiza status "assistindo" da aula clicada
            postStatusAssistindo($("#assistindoAulaId").val(), $("#alunoId").val());

            getAnotacoes($(obj.target).attr("id"), $("#alunoId").val());
            getMaterialApoio($(obj.target).attr("id"));
            getArquivosApoio($(obj.target).attr("id"));

        });

        // Quando clica em Assistida
        $("#checkAssistida").click(function () {
            if ($("#checkAssistida").is(":checked")) {
                $("#" + $("#assistindoAulaId").val()).parent().addClass("realizado");

                // Atualiza status "assistida" da aula clicada
                postStatusAssistida($("#assistindoAulaId").val(), $("#alunoId").val());
            }
        });
    });
    function getAnotacoes(aulaId, alunoId) {
        var url = '/pt-br/SalaAulas/GetAnotacoes/';
        var dados = { aulaId: aulaId, alunoId: alunoId }
        $.get(url, dados,
            function (returnedData) {
                $("#validationTextarea").val(returnedData);
            }
        )
    };
    function getMaterialApoio(aulaId) {
        var url = '/pt-br/SalaAulas/GetMaterialApoio/';
        var dados = { aulaId: aulaId }

        $("#materialApoio").text('');

        $.get(url, dados,
            function (returnedData) {
                $("#materialApoio").text(returnedData);
            }
        )
    };
    function getArquivosApoio(aulaId) {
        var url = '/pt-br/SalaAulas/GetArquivosApoio/';
        var dados = { aulaId: aulaId }

        $("#arquivosApoio").text('');

        $.get(url, dados,
            function (returnedData) {
                for (i = 0; i < returnedData.length; i++) {
                    $("#arquivosApoio").append('<a href="' + returnedData[i] + '">' + returnedData[i] + '</a><br>');
                }
            }, "json");

    };
    function GetAvaliacaoEnabled(aulaId, alunoId) {
        var url = '/pt-br/SalaAulas/GetAvaliacaoEnabled/';
        var dados = { aulaId: aulaId, alunoId: alunoId }

        $.get(url, dados,
            function (returnedData) {
                $(returnedData.nomeBotao).prop('hidden', !returnedData.enabled);
                if (returnedData.enabled) {
                    $('#avaliacaoLiberada').modal();
                }
            }, "json");

    };
    function getStatusCheckAssistida(aulaId, alunoId) {
        var url = '/pt-br/SalaAulas/GetStatusCheckAssistida/';
        var dados = { aulaId: aulaId, alunoId: alunoId }

        $.get(url, dados,
            function (returnedData) {
                $("#checkAssistida").prop("disabled", !returnedData.habilitar);
                $("#checkAssistida").prop("checked", returnedData.assistida);
            }
        )
    };
    function postAnotacoes(aulaId, alunoId, anotacoes) {
        var url = '/pt-br/SalaAulas/PostAnotacoes/';
        var dados = { aulaId: aulaId, alunoId: alunoId, anotacoes: anotacoes }
        $.post(url, dados,
            function (returnedData) {
                //alert(returnedData);
            }
        )
    };

    function postStatusAssistindo(aulaId, alunoId) {
        var url = '/pt-br/SalaAulas/UpdateAssistindoAula/';
        var dados = { aulaId: aulaId, alunoId: alunoId };

        $.post(url, dados,
            function (returnedData) {
                //console.log(returnedData);
            }
        );
    };

    function postStatusAssistida(aulaId, alunoId) {
        var url = '/pt-br/SalaAulas/UpdateAulaAssistida/';
        var dados = { aulaId: aulaId, alunoId: alunoId };

        $.post(url, dados,
            function (returnedData) {
                //console.log(returnedData);
                $("#checkAssistida").prop("disabled", true);
                GetAvaliacaoEnabled($("#assistindoAulaId").val(), $("#alunoId").val());
            }
        );
    };

    function AbrirMenu() {
        $(".btn-avaliacao").css("display", "block")
        $(".menuAulas").css("max-width", "600px");
        $(".menuAulas").css("max-height", "1000px");
        $(".modulo").css("display", "block");
        $(".menuAulas h2").css("display", "block");
        $(".fecharMenu").css("display", "block");
        $(".videoAula").removeClass("col-11");
        $(".videoAula").addClass("col-9");

    };

    function FecharMenu() {
        $(".btn-avaliacao").css("display", "none")
        $(".menuAulas").css("max-height", "50px");
        $(".menuAulas").css("max-width", "40px");

        $(".modulo").css("display", "none");
        $(".menuAulas h2").css("display", "none");
        $(".fecharMenu").css("display", "none");
        $(".videoAula").removeClass("col-9");
        $(".videoAula").addClass("col-11");

    };

    function PlayVideo(url) {

        if (url.indexOf("www.youtube") >= 0) {
            url = url.split('v=')[1];
            $("#iFrame")[0].src = "//www.youtube.com/embed/" + url;
        } else {
            $("#iFrame")[0].src = url;
        }

        $("#iFrame").show();
    };

</script>